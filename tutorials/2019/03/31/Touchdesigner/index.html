<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    <meta name="description" content="BOJIT Projects, tutorials and ramblings.">
    <meta name="keywords" content="BOJIT,Github,James Bennion-Pedley,engineering,
    programming,Raspberry Pi,Linux,C++,MagicQ,lighting,theatre,electronics">

    <!--Author-->
    <meta name="author" content="James B-P">
    

    <!--Open Graph Title + Favicon -->
    <meta property="og:title" content="BOJIT"/>
    <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/img/favicon.ico" type="image/x-icon">
    
    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="BOJIT"/>

    <!--Type page-->
    <meta property="og:type" content="website" />
    

    <!--Page Cover-->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="BOJIT>" />
    
    <!-- Title -->  
    <title>Touchdesigner Images -> DMX</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/w3.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Amatic+SC|Comfortaa|Gloria+Hallelujah|Gochi+Hand|Kalam|Shadows+Into+Light&display=swap" rel="stylesheet">

    <!-- Styles -->
    <style> 
        body {
            margin: 0;
            padding: 0;
        }
        h2 {
            font-family: 'Gloria Hallelujah', cursive;
        }
        h4 {
            font-family: 'Gloria Hallelujah', cursive;
        }
        p {
            font-family: 'Comfortaa', cursive;
        }
        h2.link:hover {
            filter: invert(100%);
        }
        img.blog_panel {
            padding: 0;
            -moz-border-radius: 0px;
            -webkit-border-radius: 0px;
            border-radius: 0px;
            width: 100%;
        }
        .navbar.navbar-default {
            background-image: linear-gradient(rgba(0,0,0,1),rgba(0,0,0,0.6),rgba(0,0,0,0));
            border: 0;
            -webkit-box-shadow: none;
            box-shadow: none;
        }
        @media (max-width: 768px) {
            .navbar.navbar-default {
                background-image: linear-gradient(rgba(255,255,255,1),rgba(255,255,255,1));
            }
        }
        #null {
            font-family: 'Comfortaa', cursive;
            font-family: 'Gloria Hallelujah', cursive;
            font-family: 'Shadows Into Light', cursive;
            font-family: 'Amatic SC', cursive;
            font-family: 'Kalam', cursive;
            font-family: 'Gochi Hand', cursive;
        }
        .tile {
            position: relative;
            text-align: center;
            color: black;
        }
        .text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: .25s ease;
            display: none;
            pointer-events: none;
            font-family: 'Gloria Hallelujah', cursive;
            font-size: calc(6vw * var(--fontMultiplier));
        }
        .blog-item {
            width: var(--desktopWidth);
        }
        @media (max-width: 768px) {
            .text {
                font-size: calc(20vw * var(--fontMultiplier));
            }
            .blog-item {
                width: 100%;
            }   
        }
        img.blog_panel:hover + .text {
            display: block;
        }
    </style>

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-141105755-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-141105755-1');
    </script>
</head>

<body>
    <!-- Menu -->
    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button style="padding:15px" type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <!-- Socials -->
                <div style="padding:10px">
                <ul class="list-inline navbar-left">
                    <li>
                        <a href="https://www.youtube.com/channel/UCR7zc0TblvkjPy9DhAWUkvA" target="_blank">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-youtube-play fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="https://www.linkedin.com/in/james-bennion-pedley-bab14a146/" target="_blank">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/BOJIT" target="_blank">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="https://www.facebook.com/James.BOJIT" target="_blank">
                        <span class="fa-stack fa-lg">
                            <i class="fa fa-circle fa-stack-2x"></i>
                            <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                        </span>
                        </a>
                    </li>
                    <li>
                        <a href="https://soundcloud.com/james-bojit" target="_blank">
                        <span class="fa-stack fa-lg">
                            <i class="fa fa-circle fa-stack-2x"></i>
                            <i class="fa fa-soundcloud fa-stack-1x fa-inverse"></i>
                        </span>
                        </a>
                    </li>
                </ul>
                </div>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    <li>
                        <a href="/projects">Projects</a>
                    </li>
                    <li>
                        <a href="/tutorials">Tutorials</a>
                    </li>
                    <li>
                        <a href="/about">About</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Main Content -->

    <!-- Page Header -->
    <!-- Set your background image for this header in the theme's configuration: index_cover -->
    <header class="intro-header" style="background-image: url('/img/BannerSmall.jpg');padding:0px">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="w3-center w3-padding-32">
                        <br>
                        <br>
                        <br>
                        <img src="/img/BOJIT_Logo_Alias_Small.png" placeholder="BOJIT"></img>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="w3-container w3-center">
        <h2 class="heading" style="color:black"><b>TOUCHDESIGNER: IMAGE -> DMX</b></h2>
        <h4 class="heading" style="color:gray">31-03-19</h4>
    </div>
    <div class="w3-container">
        <div class="w3-container">
            <p>
                For a recent theatre production I was involved in,
                I had to do some complex DMX pixel mapping as part of our lighting set. Normally I tackle most lighting programming with a program
                called MagicQ. The software is free and identical to the software used on professional Chamsys desks, but it does have its limitations. 
                For one, the internal pixel mapping engine (pictured below) is not the best. It is usable for simple eye-candy effects with Sunstrips and LED
                battens, but for anything more exacting than this it is a pain to use. While you can get slightly more functionality by hooking the console up to
                a media server, but in my opinion, it is better to completely bypass MagicQ and use something else as the pixel mapping engine.<br>
                In my search for that 'something else', I came across <i>Touchdesigner</i>. While it is primarily a video manipulation tool, the sheer number
                of IO options in the software make it very flexible for all kinds of scripting/automation tasks. For the show I was working on, I used 
                <i>Touchdesigner</i> for more than just pixel-mapping, but in this article I will focus solely on how to create a simple Image->DMX pixel mapper
                in <i>Touchdesigner</i>. To see what else I did with the software, read <a href="https://bojit.github.io/projects/2019/03/10/Kinect_Grid/">this article</a>.
            </p>
            <div class="w3-container blog-item" style="margin:auto;--desktopWidth:50%">
                <img src="img/MagicQ.png" placeholder="MagicQ Pixel Mapping" width="100%">
            </div>
            <p>
                The method outlined here is far from the only way of pixel mapping in <i>Touchdesigner</i>. I have seen some very
                sophisticated 3D rendering engines and complex node systems for efficient GPU utilisation, and I would highly recommend 
                taking a look at them, but this method is relatively simple to understand and modify, if you are a newbie like me. :)
                If you are looking for more information on how to make more complex rendering systems, I would encourage you to check
                out <a href="https://matthewragan.com/teaching-resources/touchdesigner/">Matthew Wragan's website.</a><br>
                To make <i>Touchdesigner</i> networks easier to follow, I like to put all operators associated with one task in their own
                container. Not only does this neaten things up, it also makes it easier to share processing modules with other people as .tox files
                Below you can see the inputs and outputs my pixel mapping engine takes: for inputs the container takes a video feed, an intensity
                slider and a washout/white slider; the outputs are the DMX channels and a preview of the pixel-mapped content. Only one
                input and output are really required, but having the preview window and the controls broken out makes troubleshooting and mapping
                controls to MIDI much easier.
            </p>
            <div class="w3-container blog-item" style="margin:auto;--desktopWidth:50%">
                <img src="img/Input_Module.JPG" placeholder="Pixel Engine Component" width="100%">
            </div>
            <p>
                Inside the container, the first group of operators simply handle video pre-processing. The video input is scaled
                to the aspect ratio of the pixel grid, then is <i>multiplied</i> by the alpha value of a constant colour. The opacity of the constant colour
                is controlled by the 'intensity' slider input. This is a simple way of controlling the 'brightness' of the video input 
                without changing the alpha values of the input, which is important later on. A similar operation is done with the 
                <i>addition</i> of a constant colour, controlled by the 'washout/white' slider input. This is an equivalent of controlling
                the 'tint' of the image. Any other processing can be done after these operators, but if working with simple dimmers or RGB fixtures,
                it makes life easier to only apply effects to the RGB channels only and leave the Alpha channel alone.
            </p>
            <div class="w3-container blog-item" style="margin:auto;--desktopWidth:50%">
                <img src="img/Input Filtering.PNG" placeholder="Input Processing + Grandmaster" width="100%">
            </div>
            <p>
                Following this pre-processing, the video is scaled to the desired resolution of the pixel grid, then a <i>TOPto->CHOP</i> 
                operator is used to turn each scan-line of the image into data channel. Following this conversion a <i>Select</i> operator is
                used to filter all the red channels (using the r* wildcard) from the image. If required, this CHOP can be directly manipulated
                to give the image data in a format that can be output over DMX, however we can deal with the data more intuitively by using a
                <i>CHOPto->DAT</i> operator to map every pixel value to a table. This table visually corresponds to the position of elements in
                the pixel grid, starting from top left and ending in the bottom right-hand corner. Note that for my project my pixel grid was made up
                of incandescent-style bulbs, so I only cared about the luminance of each pixel in the video feed, meaning it did not matter whether I
                looked at the R,G or B channel of the data. However if working with RGB fixtures we would need to have 3 separate tables for each colour channel.
            </p>
            <div class="w3-container blog-item" style="margin:auto;--desktopWidth:50%">
                <img src="img/TOPtoCHOP.png" placeholder="TOP to CHOP image mapping" width="100%">
            </div>
            <p>
                Now that we have a nice grid of all our pixel values, we need to turn them into a format that our <i>DMX</i> operator can understand.
                In my case I was using an Entecc DMX-USB Pro as the physical DMX interface, but the operator also supports output over ArtNet. We need
                to map our data to a stream of 512 channels with values between 0 and 255. If you are working in 24 bit-per-pixel colour space (8 bits per channel)
                , you probably already have the right range of values per DMX channel, so all we really need to do is map the value of each table cell to one of the
                512 output channels. With the image data in DAT form this is relatively straightforward.<br>
                The first step is to generate 512 empty channels. In <i>Touchdesigner</i> there is a special syntax for doing this with a <i>Constant</i> operator.
                Simply type <b>chan[1-512]</b> into the first entry of the operator, and you're done! It is worth noting that while both Touchdesigner and standard 
                DMX work with DMX channels label DMX addresses 1-512, many computer processes and older lighting hardware work with addresses 0-511, so if you experience
                an 'out by one' error when doing fixture addressing, this may be why.
                
            </p>
            <div class="w3-container blog-item" style="margin:auto;--desktopWidth:50%">
                <img src="img/output_processing.png" placeholder="Output to DMX interface" width="100%">
            </div>
            <p>
                To extract the pixel values in a logical order, we can use the <i>DATto->CHOP</i> operator, using the settings pictured above. This
                will create channel names that start from 1, up to the number of cells in the table, with the numbers ascending left to right, top to bottom in the table.
                For monochrome grid systems, this is all the processing required, but for RGB systems all 3 tables must have their channel <i>names</i> multiplied
                by 3 then offset by a specific amount. This data is in a format that can be fed directly into the <i>DMX</i> operator, but there is one 
                remaining problem. The pixel grid we are using is not necessarily patched at address 1, so the channels need to be offset to the correct address.
                Note we are not adding an offset to the channel value, but to the channel names themselves. This is done with the <i>Rename</i> and <i>Replace</i>
                CHOPs. Say we wanted to patch a 6x6 grid starting at address 301, we would use the <i>Rename</i> CHOP to map '<b>*</b>' to <b>chan[301-336]</b>, then
                replace the constant channels with our image pixel values in the main channel output. This arrangement is shown above.<br>
                This is the part of the pixel engine I am least pleased with, as the start address cannot be set with an external CHOP, and the <i>Rename</i> CHOP does
                not adapt to changes in the grid resolution. When I first made this system I was up against a show deadline, so left this annoyance in. If in the future
                I design a better system, I will update this page and post the module as a .tox file.<br><br>
                Below is a picture of the the core pixel mapping Touchdesigner network, and I have attached my sample touch files <a href="/projects/2019/03/10/Kinect_Grid/Kinect_Grid.toe">here</a>,
                in case anyone finds them useful. There are numerous ways to enhance this system, but hopefully the information provided here will be useful if you
                are doing any projects with similar elements to this. Do check out the <a href="https://bojit.github.io/projects/2019/03/10/Kinect_Grid/">project I used this 
                pixel-mapper for</a>, which combines this with lots of hanging light-bulbs and an Xbox Kinect!
            </p>
            <div class="w3-container blog-item" style="margin:auto;--desktopWidth:70%">
                <img src="img/touchdesigner.PNG" placeholder="Overall Node Structure" width="100%">
            </div>
            <br>
        </div>
    </div>

    <!-- Disqus Comments -->
    <div class="w3-container">
        <div class="w3-container">
            <div id="disqus_thread"></div>
            <script>
                (function() {
                var d = document, s = d.createElement('script');
                s.src = '//https-bojit-github-io.disqus.com/embed.js';
                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </div>
    </div>

    <!-- Footer -->
    <hr />

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                        <li>
                            <a href="https://www.youtube.com/channel/UCR7zc0TblvkjPy9DhAWUkvA" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-youtube-play fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="https://www.linkedin.com/in/james-bennion-pedley-bab14a146/" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="https://github.com/BOJIT" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="https://www.facebook.com/James.BOJIT" target="_blank">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                            </a>
                        </li>
                        <li>
                            <a href="https://soundcloud.com/james-bojit" target="_blank">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-soundcloud fa-stack-1x fa-inverse"></i>
                            </span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <!-- After footer scripts -->
    
    <!-- Tiler -->
    <script src="js/display.js"></script>
    
    <!-- jQuery -->
    <script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

    <!-- Bootstrap -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <!-- Gallery -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

    <!-- Disqus Comments -->
    <script type="text/javascript">
        var disqus_shortname = 'BOJIT-blog';
        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>
</body>

</html>