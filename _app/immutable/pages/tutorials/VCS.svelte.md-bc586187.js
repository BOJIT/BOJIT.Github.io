import{S as Ao,i as So,s as Ro,e as l,t as n,k as c,w as Q,c as i,a as r,h as o,d as e,m as u,x as tt,b as f,U as Do,g as p,K as s,y as et,E as jo,q as st,o as at,B as nt}from"../../chunks/index-cabb4aca.js";import{C as ot}from"../../chunks/prism-c-2b701845.js";import"../../chunks/prism-a46989fb.js";import"../../chunks/prism-bash-4c44f9e3.js";import"../../chunks/Notification-908d3fcd.js";import"../../chunks/index-6a3c8aa1.js";import"../../chunks/ripple-d87e32e1.js";/* empty css                                                            */Prism.languages.python={comment:{pattern:/(^|[^\\])#.*/,lookbehind:!0,greedy:!0},"string-interpolation":{pattern:/(?:f|fr|rf)(?:("""|''')[\s\S]*?\1|("|')(?:\\.|(?!\2)[^\\\r\n])*\2)/i,greedy:!0,inside:{interpolation:{pattern:/((?:^|[^{])(?:\{\{)*)\{(?!\{)(?:[^{}]|\{(?!\{)(?:[^{}]|\{(?!\{)(?:[^{}])+\})+\})+\}/,lookbehind:!0,inside:{"format-spec":{pattern:/(:)[^:(){}]+(?=\}$)/,lookbehind:!0},"conversion-option":{pattern:/![sra](?=[:}]$)/,alias:"punctuation"},rest:null}},string:/[\s\S]+/}},"triple-quoted-string":{pattern:/(?:[rub]|br|rb)?("""|''')[\s\S]*?\1/i,greedy:!0,alias:"string"},string:{pattern:/(?:[rub]|br|rb)?("|')(?:\\.|(?!\1)[^\\\r\n])*\1/i,greedy:!0},function:{pattern:/((?:^|\s)def[ \t]+)[a-zA-Z_]\w*(?=\s*\()/g,lookbehind:!0},"class-name":{pattern:/(\bclass\s+)\w+/i,lookbehind:!0},decorator:{pattern:/(^[\t ]*)@\w+(?:\.\w+)*/m,lookbehind:!0,alias:["annotation","punctuation"],inside:{punctuation:/\./}},keyword:/\b(?:_(?=\s*:)|and|as|assert|async|await|break|case|class|continue|def|del|elif|else|except|exec|finally|for|from|global|if|import|in|is|lambda|match|nonlocal|not|or|pass|print|raise|return|try|while|with|yield)\b/,builtin:/\b(?:__import__|abs|all|any|apply|ascii|basestring|bin|bool|buffer|bytearray|bytes|callable|chr|classmethod|cmp|coerce|compile|complex|delattr|dict|dir|divmod|enumerate|eval|execfile|file|filter|float|format|frozenset|getattr|globals|hasattr|hash|help|hex|id|input|int|intern|isinstance|issubclass|iter|len|list|locals|long|map|max|memoryview|min|next|object|oct|open|ord|pow|property|range|raw_input|reduce|reload|repr|reversed|round|set|setattr|slice|sorted|staticmethod|str|sum|super|tuple|type|unichr|unicode|vars|xrange|zip)\b/,boolean:/\b(?:False|None|True)\b/,number:/\b0(?:b(?:_?[01])+|o(?:_?[0-7])+|x(?:_?[a-f0-9])+)\b|(?:\b\d+(?:_\d+)*(?:\.(?:\d+(?:_\d+)*)?)?|\B\.\d+(?:_\d+)*)(?:e[+-]?\d+(?:_\d+)*)?j?(?!\w)/i,operator:/[-+%=]=?|!=|:=|\*\*?=?|\/\/?=?|<[<=>]?|>[=>]?|[&|^~]/,punctuation:/[{}[\];(),.:]/};Prism.languages.python["string-interpolation"].inside.interpolation.inside.rest=Prism.languages.python;Prism.languages.py=Prism.languages.python;Prism.languages.json={property:{pattern:/(^|[^\\])"(?:\\.|[^\\"\r\n])*"(?=\s*:)/,lookbehind:!0,greedy:!0},string:{pattern:/(^|[^\\])"(?:\\.|[^\\"\r\n])*"(?!\s*:)/,lookbehind:!0,greedy:!0},comment:{pattern:/\/\/.*|\/\*[\s\S]*?(?:\*\/|$)/,greedy:!0},number:/-?\b\d+(?:\.\d+)?(?:e[+-]?\d+)?\b/i,punctuation:/[{}[\],]/,operator:/:/,boolean:/\b(?:false|true)\b/,null:{pattern:/\bnull\b/,alias:"keyword"}};Prism.languages.webmanifest=Prism.languages.json;function Ho(ko){let d,xt,fs,ms,$t,ds,hs,At,ks,bs,H,ys,vs,ie,pt,lt,mn,re,m,ws,St,_s,gs,Rt,Es,Ps,Dt,Ts,Cs,jt,Is,Os,Ht,xs,$s,ce,w,As,P,Ft,Ss,Rs,Ds,Mt,js,Hs,ue,it,Fs,fe,rt,Ms,me,k,Vs,Vt,Gs,Ls,Gt,Us,Bs,Lt,qs,Ns,de,ct,Ks,he,F,ke,M,bo=`<code class="language-python"><span class="token comment"># Get predefined C macro (could be defined by build system or .ini file)</span>
<span class="token keyword">for</span> item <span class="token keyword">in</span> env<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"CPPDEFINES"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'PORT_TYPE'</span><span class="token punctuation">:</span>
            port_type <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

<span class="token comment"># Configure source and include paths based on this macro</span>
env<span class="token punctuation">.</span>Append<span class="token punctuation">(</span>CPPPATH<span class="token operator">=</span><span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>realpath<span class="token punctuation">(</span><span class="token string">"FreeRTOS-Kernel/include"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
env<span class="token punctuation">.</span>Append<span class="token punctuation">(</span>CPPPATH<span class="token operator">=</span><span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>realpath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">"FreeRTOS-Kernel/portable/GCC/"</span><span class="token punctuation">,</span> port_type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
env<span class="token punctuation">.</span>Replace<span class="token punctuation">(</span>SRC_FILTER<span class="token operator">=</span><span class="token punctuation">[</span>
        <span class="token string">"+&lt;FreeRTOS-Kernel/>"</span><span class="token punctuation">,</span>
        <span class="token string">"-&lt;FreeRTOS-Kernel/portable/>"</span><span class="token punctuation">,</span>
        <span class="token string">"+&lt;FreeRTOS-Kernel/portable/MemMang/heap_4.c>"</span><span class="token punctuation">,</span>
        os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">"+&lt;FreeRTOS-Kernel/portable/GCC/"</span><span class="token punctuation">,</span> port_type<span class="token punctuation">,</span> <span class="token string">">"</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span></code>`,be,_,Ws,Ut,Js,zs,V,Ys,Zs,ye,ut,Xs,ve,T,Qs,Bt,ta,ea,we,C,sa,qt,aa,na,_e,G,ge,L,yo=`<code class="language-python"><span class="token keyword">def</span> <span class="token function">getRemoteTags</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    g <span class="token operator">=</span> git<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span>Git<span class="token punctuation">(</span><span class="token punctuation">)</span>
    blob <span class="token operator">=</span> g<span class="token punctuation">.</span>ls_remote<span class="token punctuation">(</span>url<span class="token punctuation">,</span> sort<span class="token operator">=</span><span class="token string">'-v:refname'</span><span class="token punctuation">,</span> tags<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> refs<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    entries <span class="token operator">=</span> blob<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'&#92;n'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>partition<span class="token punctuation">(</span><span class="token string">'refs/tags/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> entries<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">getLocalTag</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    g <span class="token operator">=</span> git<span class="token punctuation">.</span>Repo<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tag <span class="token keyword">for</span> tag <span class="token keyword">in</span> g<span class="token punctuation">.</span>tags <span class="token keyword">if</span> tag<span class="token punctuation">.</span>commit <span class="token operator">==</span> g<span class="token punctuation">.</span>head<span class="token punctuation">.</span>commit<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">pass</span></code>`,Ee,I,oa,Nt,pa,la,Pe,ft,ia,Te,b,ra,U,ca,ua,Kt,fa,ma,Wt,da,ha,Ce,mt,ka,Ie,dt,ba,Oe,ht,ya,xe,kt,va,$e,O,wa,Jt,_a,ga,Ae,B,Se,q,vo=`<code class="language-python"><span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> example
<span class="token keyword">except</span> ImportError<span class="token punctuation">:</span>
    env<span class="token punctuation">.</span>Execute<span class="token punctuation">(</span><span class="token string">"$PYTHONEXE -m pip install example"</span><span class="token punctuation">)</span>
    <span class="token keyword">import</span> example
</code>`,Re,bt,Ea,De,g,Pa,zt,Ta,Ca,Yt,Ia,Oa,je,y,xa,Zt,$a,Aa,Xt,Sa,Ra,Qt,Da,ja,He,N,Fe,K,wo=`<code class="language-python"><span class="token comment"># This script snippet works from any build context!</span>
env<span class="token punctuation">.</span>Append<span class="token punctuation">(</span>CPPPATH<span class="token operator">=</span>env<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"PROJECT_INCLUDE_DIR"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code>`,Me,h,Ha,te,Fa,Ma,ee,Va,Ga,se,La,Ua,ae,Ba,qa,Ve,yt,Na,Ge,vt,Ka,Le,x,Wa,ne,Ja,za,Ue,wt,Ya,Be,W,qe,J,_o=`<code class="language-c"><span class="token keyword">const</span> <span class="token class-name">vcs_t</span> vcs <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#123;</span><span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token number">0xFE</span><span class="token punctuation">,</span> <span class="token number">0xFD</span><span class="token punctuation">,</span> <span class="token number">0xFC</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>   <span class="token comment">/* frame_start */</span>
    <span class="token number">1</span><span class="token punctuation">,</span>                          <span class="token comment">/* schema */</span>
    __VCS_COMPILE_TIME<span class="token punctuation">,</span>         <span class="token comment">/* compile_time */</span>
    __VCS_SHORT_HASH<span class="token punctuation">,</span>           <span class="token comment">/* short_hash */</span>
    __VCS_IS_DIRTY<span class="token punctuation">,</span>             <span class="token comment">/* is_dirty */</span>
    __VCS_TAG_DESCRIBE<span class="token punctuation">,</span>         <span class="token comment">/* tag_describe */</span>
    __VCS_LAST_AUTHOR<span class="token punctuation">,</span>          <span class="token comment">/* author */</span>
    <span class="token punctuation">&#123;</span><span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">&#125;</span>    <span class="token comment">/* frame_end */</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code>`,Ne,_t,Za,Ke,z,We,Y,go=`<code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">"compile_time"</span><span class="token operator">:</span> <span class="token string">"2022-01-13T12:03Z"</span><span class="token punctuation">,</span>
    <span class="token property">"short_hash"</span><span class="token operator">:</span> <span class="token string">"293b1c5"</span><span class="token punctuation">,</span>
    <span class="token property">"is_dirty"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"tag_describe"</span><span class="token operator">:</span> <span class="token string">"1.0.0-2-g293b1c5"</span><span class="token punctuation">,</span>
    <span class="token property">"last_author"</span><span class="token operator">:</span> <span class="token string">"James Bennion-Pedley"</span>
<span class="token punctuation">&#125;</span></code>`,Je,$,Xa,oe,Qa,tn,ze,gt,en,Ye,Et,sn,Ze,Pt,an,Xe,Tt,nn,Qe,Z,ts,X,Eo=`<code class="language-bash">$ get_vcs.py ./<span class="token environment constant">PATH</span>/TO-FIRMWARE.bin
<span class="token comment"># OR</span>
$ python3 get_vcs.py ./<span class="token environment constant">PATH</span>/TO-FIRMWARE.bin

<span class="token comment"># Pass the 'clean' flag for just VCS output (scripting)</span>
$ get_vcs.py --clean ./<span class="token environment constant">PATH</span>/TO-FIRMWARE.bin <span class="token operator">></span> something_else
</code>`,es,A,on,pe,pn,ln,ss,S,rn,le,cn,un,as;return F=new ot({}),G=new ot({}),B=new ot({}),N=new ot({}),W=new ot({}),z=new ot({}),Z=new ot({}),{c(){d=l("p"),xt=l("code"),fs=n("VCS"),ms=c(),$t=l("em"),ds=n("(Version Control System)"),hs=n(" is a simple script that works with the "),At=l("code"),ks=n("PlatformIO"),bs=n(" build system to add useful metadata to the output binaries of embedded projects. The exact workings of the tool are documented on "),H=l("a"),ys=n("GitHub"),vs=n(", so I won\u2019t dive into detail here. This article focuses more on the internals of the library and some of the cool things you can do with the scripting engine."),ie=c(),pt=l("p"),lt=l("img"),re=c(),m=l("p"),ws=n("PlatformIO is built on "),St=l("code"),_s=n("Python"),gs=n(". Any valid "),Rt=l("code"),Es=n("Python"),Ps=n(" can be executed in the context of the build environment, and if you are somewhat familiar with the "),Dt=l("code"),Ts=n("SCons"),Cs=n(" build environment that "),jt=l("code"),Is=n("PlatformIO"),Os=n(" uses, then you can pretty much mess with any part of the "),Ht=l("code"),xs=n("C/C++"),$s=n(" build process!"),ce=c(),w=l("p"),As=n("The "),P=l("a"),Ft=l("code"),Ss=n("PlatformIO"),Rs=n(" docs"),Ds=n(" give a thorough breakdown of the "),Mt=l("code"),js=n("SCons"),Hs=n(" API, but it is quite light on real-life examples."),ue=c(),it=l("p"),Fs=n("Below are a few examples of useful things that the PlatformIO scripting API can help you do:"),fe=c(),rt=l("h3"),Ms=n("Automated Upstream Library Configuration"),me=c(),k=l("p"),Vs=n("The "),Vt=l("code"),Gs=n("SCons"),Ls=n(" build system allows the source and include paths to be edited programatically. I have used this in the past to configure libraries pulled directly from an upstream source. "),Gt=l("code"),Us=n("FreeRTOS"),Bs=n(" is a good example of where this is useful. To use the library directly, you need to choose a target architecture "),Lt=l("code"),qs=n("port.c"),Ns=n(" file, choose a memory management scheme, and configure some basic options."),de=c(),ct=l("p"),Ks=n("In the scripting API you have access to all of your platform build variables, so it makes easy to configure these options automatically based on your target environment. An example of that could be:"),he=c(),Q(F.$$.fragment),ke=c(),M=l("pre"),be=c(),_=l("p"),Ws=n("A more complete example of this behaviour is shown in my "),Ut=l("code"),Js=n("PlatformIO-FreeRTOS"),zs=c(),V=l("a"),Ys=n("library"),Zs=n("."),ye=c(),ut=l("h3"),Xs=n("Tagged Version Fetching"),ve=c(),T=l("p"),Qs=n("PlatformIO does have built-in support for fetching Git repositories, but this only works if that repository is in the default library format or contains a "),Bt=l("code"),ta=n("library.json"),ea=n(" file. With the advanced scripting engine you can fetch the library on-the-fly and modify it."),we=c(),C=l("p"),sa=n("I have used the "),qt=l("code"),aa=n("GitPython"),na=n(" package in the past. It allows you to fetch and manage Git repositories programatically. Two functions I use extensively are:"),_e=c(),Q(G.$$.fragment),ge=c(),L=l("pre"),Ee=c(),I=l("p"),oa=n("This is handy for some automated library work, but where it really shines is in a corporate environment. Many teams at work have trouble keeping certain build data/settings synchronised across projects. Adding a "),Nt=l("code"),pa=n("lib-build.py"),la=n(" to our default project template effectively \u2018forces\u2019 team members to keep certain dependencies up to date!"),Pe=c(),ft=l("h3"),ia=n("Asset Bundling"),Te=c(),b=l("p"),ra=n("Projects involving UI and IoT often involve assets that cannot be natively compiled by a C compiler. Examples include UI Images and FileSystem data for web servers. There exist "),U=l("a"),ca=n("tools"),ua=n(" to do this sort of thing, but they are mostly web-based or use ancient scripting languages like "),Kt=l("em"),fa=n("perl"),ma=n(". These assets are also tricky to incorporate into CI/CD toolchains, meaning "),Wt=l("em"),da=n("compiled"),ha=n(" assets often just get left in source control. A nice alternative would be to have these assets treated as part of the compilation framework, similar to how web bundlers work."),Ce=c(),mt=l("h3"),ka=n("Certificate Management and Authentication"),Ie=c(),dt=l("p"),ba=n("IoT projects typically require API keys, certificates, MAC addresses and other product-specific information embedded in the firmware. In industry specialised tools exist to modify binaries when programming devices on a production line. This is impractical for most hobbyists, but for small production runs have a slightly more automated firmware build system is probably desirable."),Oe=c(),ht=l("h2"),ya=n("Tips and Tricks"),xe=c(),kt=l("p"),va=n("There are a few parts of the scripting API that initially caught me out."),$e=c(),O=l("p"),wa=n("The first of these is importing Third-Party "),Jt=l("code"),_a=n("python"),ga=n(" packages when in the build environment. Packages must be installed within PlatformIO\u2019s own python virtual environment: this can be done from within the build script with the following snippet:"),Ae=c(),Q(B.$$.fragment),Se=c(),q=l("pre"),Re=c(),bt=l("p"),Ea=n("The second \u2018Gotcha\u2019 is the understanding of build scope from within libraries."),De=c(),g=l("p"),Pa=n("When using scripting from the main "),zt=l("code"),Ta=n("platformio.ini"),Ca=n(" file, we are modifying the build environment of our main codebase: Aside from build_flags these changes do not propogate down to our libraries. Likewise, when calling build scripts from within "),Yt=l("code"),Ia=n("library.json"),Oa=n(", we are modifying the build environment of that library, not the whole project."),je=c(),y=l("p"),xa=n("This can be a bit confusing when it comes to global config files. Projects such as "),Zt=l("code"),$a=n("lwIP"),Aa=n(", "),Xt=l("code"),Sa=n("freeRTOS"),Ra=n(" and "),Qt=l("code"),Da=n("lvgl"),ja=n(" use global config files that must be added to your project. However, by default, your project include paths are not passed to libraries when they are complied. A simple workaround is to use the scripting API to add the root include directory to your libary build:"),He=c(),Q(N.$$.fragment),Fe=c(),K=l("pre"),Me=c(),h=l("p"),Ha=n("The final tip is to run your builds using the "),te=l("code"),Fa=n("-v"),Ma=c(),ee=l("em"),Va=n("(verbose)"),Ga=n(" flag when writing scripts. Ultimately all "),se=l("code"),La=n("SCons"),Ua=n(" is doing is deciding what needs to be recompiled and passing the appropriate flags to "),ae=l("code"),Ba=n("gcc"),qa=n("."),Ve=c(),yt=l("p"),Na=n("Anyway\u2026 I\u2019ve got sidetracked\u2026 back to the library!"),Ge=c(),vt=l("h2"),Ka=n("VCS Usage"),Le=c(),x=l("p"),Wa=n("The library doesn\u2019t really require any interaction: all you need to do to activate it is add the library your "),ne=l("code"),Ja=n("platformio.ini"),za=n(" file and the rest is handled automatically."),Ue=c(),wt=l("p"),Ya=n("The library generates the following entry as a global C-struct"),Be=c(),Q(W.$$.fragment),qe=c(),J=l("pre"),Ne=c(),_t=l("p"),Za=n("An example output for a typical compilation may look something like this:"),Ke=c(),Q(z.$$.fragment),We=c(),Y=l("pre"),Je=c(),$=l("p"),Xa=n("You can access the "),oe=l("code"),Qa=n("vcs"),tn=n(" struct anywhere you include the header, so the output can be used in your program."),ze=c(),gt=l("h2"),en=n("Checking Versions"),Ye=c(),Et=l("p"),sn=n("Looking through binaries for an embedded bit of metadata is tedious. Ideally I would have liked to place the metadata at the start or end of the firmware binary, but doing this would involve programatically editing the linker file, which just seems like asking for trouble."),Ze=c(),Pt=l("p"),an=n("Instead, the library includes a simple python script that searches for a \u2018magic pattern\u2019 that signifies the fixed-size metadata block."),Xe=c(),Tt=l("p"),nn=n("simply get your binary file, download the script and run the following python command:"),Qe=c(),Q(Z.$$.fragment),ts=c(),X=l("pre"),es=c(),A=l("p"),on=n("This will return you the metadata in "),pe=l("code"),pn=n("JSON"),ln=n(" format."),ss=c(),S=l("p"),rn=n("This library was an excellent excuse to play about with the python scripting capabilities of "),le=l("code"),cn=n("PlatformIO"),un=n(". Hopefully someone else finds it useful too!"),this.h()},l(t){d=i(t,"P",{});var a=r(d);xt=i(a,"CODE",{});var dn=r(xt);fs=o(dn,"VCS"),dn.forEach(e),ms=u(a),$t=i(a,"EM",{});var hn=r($t);ds=o(hn,"(Version Control System)"),hn.forEach(e),hs=o(a," is a simple script that works with the "),At=i(a,"CODE",{});var kn=r(At);ks=o(kn,"PlatformIO"),kn.forEach(e),bs=o(a," build system to add useful metadata to the output binaries of embedded projects. The exact workings of the tool are documented on "),H=i(a,"A",{href:!0,rel:!0});var bn=r(H);ys=o(bn,"GitHub"),bn.forEach(e),vs=o(a,", so I won\u2019t dive into detail here. This article focuses more on the internals of the library and some of the cool things you can do with the scripting engine."),a.forEach(e),ie=u(t),pt=i(t,"P",{});var yn=r(pt);lt=i(yn,"IMG",{src:!0,alt:!0}),yn.forEach(e),re=u(t),m=i(t,"P",{});var v=r(m);ws=o(v,"PlatformIO is built on "),St=i(v,"CODE",{});var vn=r(St);_s=o(vn,"Python"),vn.forEach(e),gs=o(v,". Any valid "),Rt=i(v,"CODE",{});var wn=r(Rt);Es=o(wn,"Python"),wn.forEach(e),Ps=o(v," can be executed in the context of the build environment, and if you are somewhat familiar with the "),Dt=i(v,"CODE",{});var _n=r(Dt);Ts=o(_n,"SCons"),_n.forEach(e),Cs=o(v," build environment that "),jt=i(v,"CODE",{});var gn=r(jt);Is=o(gn,"PlatformIO"),gn.forEach(e),Os=o(v," uses, then you can pretty much mess with any part of the "),Ht=i(v,"CODE",{});var En=r(Ht);xs=o(En,"C/C++"),En.forEach(e),$s=o(v," build process!"),v.forEach(e),ce=u(t),w=i(t,"P",{});var Ct=r(w);As=o(Ct,"The "),P=i(Ct,"A",{href:!0,rel:!0});var fn=r(P);Ft=i(fn,"CODE",{});var Pn=r(Ft);Ss=o(Pn,"PlatformIO"),Pn.forEach(e),Rs=o(fn," docs"),fn.forEach(e),Ds=o(Ct," give a thorough breakdown of the "),Mt=i(Ct,"CODE",{});var Tn=r(Mt);js=o(Tn,"SCons"),Tn.forEach(e),Hs=o(Ct," API, but it is quite light on real-life examples."),Ct.forEach(e),ue=u(t),it=i(t,"P",{});var Cn=r(it);Fs=o(Cn,"Below are a few examples of useful things that the PlatformIO scripting API can help you do:"),Cn.forEach(e),fe=u(t),rt=i(t,"H3",{});var In=r(rt);Ms=o(In,"Automated Upstream Library Configuration"),In.forEach(e),me=u(t),k=i(t,"P",{});var R=r(k);Vs=o(R,"The "),Vt=i(R,"CODE",{});var On=r(Vt);Gs=o(On,"SCons"),On.forEach(e),Ls=o(R," build system allows the source and include paths to be edited programatically. I have used this in the past to configure libraries pulled directly from an upstream source. "),Gt=i(R,"CODE",{});var xn=r(Gt);Us=o(xn,"FreeRTOS"),xn.forEach(e),Bs=o(R," is a good example of where this is useful. To use the library directly, you need to choose a target architecture "),Lt=i(R,"CODE",{});var $n=r(Lt);qs=o($n,"port.c"),$n.forEach(e),Ns=o(R," file, choose a memory management scheme, and configure some basic options."),R.forEach(e),de=u(t),ct=i(t,"P",{});var An=r(ct);Ks=o(An,"In the scripting API you have access to all of your platform build variables, so it makes easy to configure these options automatically based on your target environment. An example of that could be:"),An.forEach(e),he=u(t),tt(F.$$.fragment,t),ke=u(t),M=i(t,"PRE",{class:!0});var Po=r(M);Po.forEach(e),be=u(t),_=i(t,"P",{});var It=r(_);Ws=o(It,"A more complete example of this behaviour is shown in my "),Ut=i(It,"CODE",{});var Sn=r(Ut);Js=o(Sn,"PlatformIO-FreeRTOS"),Sn.forEach(e),zs=u(It),V=i(It,"A",{href:!0,rel:!0});var Rn=r(V);Ys=o(Rn,"library"),Rn.forEach(e),Zs=o(It,"."),It.forEach(e),ye=u(t),ut=i(t,"H3",{});var Dn=r(ut);Xs=o(Dn,"Tagged Version Fetching"),Dn.forEach(e),ve=u(t),T=i(t,"P",{});var ns=r(T);Qs=o(ns,"PlatformIO does have built-in support for fetching Git repositories, but this only works if that repository is in the default library format or contains a "),Bt=i(ns,"CODE",{});var jn=r(Bt);ta=o(jn,"library.json"),jn.forEach(e),ea=o(ns," file. With the advanced scripting engine you can fetch the library on-the-fly and modify it."),ns.forEach(e),we=u(t),C=i(t,"P",{});var os=r(C);sa=o(os,"I have used the "),qt=i(os,"CODE",{});var Hn=r(qt);aa=o(Hn,"GitPython"),Hn.forEach(e),na=o(os," package in the past. It allows you to fetch and manage Git repositories programatically. Two functions I use extensively are:"),os.forEach(e),_e=u(t),tt(G.$$.fragment,t),ge=u(t),L=i(t,"PRE",{class:!0});var To=r(L);To.forEach(e),Ee=u(t),I=i(t,"P",{});var ps=r(I);oa=o(ps,"This is handy for some automated library work, but where it really shines is in a corporate environment. Many teams at work have trouble keeping certain build data/settings synchronised across projects. Adding a "),Nt=i(ps,"CODE",{});var Fn=r(Nt);pa=o(Fn,"lib-build.py"),Fn.forEach(e),la=o(ps," to our default project template effectively \u2018forces\u2019 team members to keep certain dependencies up to date!"),ps.forEach(e),Pe=u(t),ft=i(t,"H3",{});var Mn=r(ft);ia=o(Mn,"Asset Bundling"),Mn.forEach(e),Te=u(t),b=i(t,"P",{});var D=r(b);ra=o(D,"Projects involving UI and IoT often involve assets that cannot be natively compiled by a C compiler. Examples include UI Images and FileSystem data for web servers. There exist "),U=i(D,"A",{href:!0,rel:!0});var Vn=r(U);ca=o(Vn,"tools"),Vn.forEach(e),ua=o(D," to do this sort of thing, but they are mostly web-based or use ancient scripting languages like "),Kt=i(D,"EM",{});var Gn=r(Kt);fa=o(Gn,"perl"),Gn.forEach(e),ma=o(D,". These assets are also tricky to incorporate into CI/CD toolchains, meaning "),Wt=i(D,"EM",{});var Ln=r(Wt);da=o(Ln,"compiled"),Ln.forEach(e),ha=o(D," assets often just get left in source control. A nice alternative would be to have these assets treated as part of the compilation framework, similar to how web bundlers work."),D.forEach(e),Ce=u(t),mt=i(t,"H3",{});var Un=r(mt);ka=o(Un,"Certificate Management and Authentication"),Un.forEach(e),Ie=u(t),dt=i(t,"P",{});var Bn=r(dt);ba=o(Bn,"IoT projects typically require API keys, certificates, MAC addresses and other product-specific information embedded in the firmware. In industry specialised tools exist to modify binaries when programming devices on a production line. This is impractical for most hobbyists, but for small production runs have a slightly more automated firmware build system is probably desirable."),Bn.forEach(e),Oe=u(t),ht=i(t,"H2",{});var qn=r(ht);ya=o(qn,"Tips and Tricks"),qn.forEach(e),xe=u(t),kt=i(t,"P",{});var Nn=r(kt);va=o(Nn,"There are a few parts of the scripting API that initially caught me out."),Nn.forEach(e),$e=u(t),O=i(t,"P",{});var ls=r(O);wa=o(ls,"The first of these is importing Third-Party "),Jt=i(ls,"CODE",{});var Kn=r(Jt);_a=o(Kn,"python"),Kn.forEach(e),ga=o(ls," packages when in the build environment. Packages must be installed within PlatformIO\u2019s own python virtual environment: this can be done from within the build script with the following snippet:"),ls.forEach(e),Ae=u(t),tt(B.$$.fragment,t),Se=u(t),q=i(t,"PRE",{class:!0});var Co=r(q);Co.forEach(e),Re=u(t),bt=i(t,"P",{});var Wn=r(bt);Ea=o(Wn,"The second \u2018Gotcha\u2019 is the understanding of build scope from within libraries."),Wn.forEach(e),De=u(t),g=i(t,"P",{});var Ot=r(g);Pa=o(Ot,"When using scripting from the main "),zt=i(Ot,"CODE",{});var Jn=r(zt);Ta=o(Jn,"platformio.ini"),Jn.forEach(e),Ca=o(Ot," file, we are modifying the build environment of our main codebase: Aside from build_flags these changes do not propogate down to our libraries. Likewise, when calling build scripts from within "),Yt=i(Ot,"CODE",{});var zn=r(Yt);Ia=o(zn,"library.json"),zn.forEach(e),Oa=o(Ot,", we are modifying the build environment of that library, not the whole project."),Ot.forEach(e),je=u(t),y=i(t,"P",{});var j=r(y);xa=o(j,"This can be a bit confusing when it comes to global config files. Projects such as "),Zt=i(j,"CODE",{});var Yn=r(Zt);$a=o(Yn,"lwIP"),Yn.forEach(e),Aa=o(j,", "),Xt=i(j,"CODE",{});var Zn=r(Xt);Sa=o(Zn,"freeRTOS"),Zn.forEach(e),Ra=o(j," and "),Qt=i(j,"CODE",{});var Xn=r(Qt);Da=o(Xn,"lvgl"),Xn.forEach(e),ja=o(j," use global config files that must be added to your project. However, by default, your project include paths are not passed to libraries when they are complied. A simple workaround is to use the scripting API to add the root include directory to your libary build:"),j.forEach(e),He=u(t),tt(N.$$.fragment,t),Fe=u(t),K=i(t,"PRE",{class:!0});var Io=r(K);Io.forEach(e),Me=u(t),h=i(t,"P",{});var E=r(h);Ha=o(E,"The final tip is to run your builds using the "),te=i(E,"CODE",{});var Qn=r(te);Fa=o(Qn,"-v"),Qn.forEach(e),Ma=u(E),ee=i(E,"EM",{});var to=r(ee);Va=o(to,"(verbose)"),to.forEach(e),Ga=o(E," flag when writing scripts. Ultimately all "),se=i(E,"CODE",{});var eo=r(se);La=o(eo,"SCons"),eo.forEach(e),Ua=o(E," is doing is deciding what needs to be recompiled and passing the appropriate flags to "),ae=i(E,"CODE",{});var so=r(ae);Ba=o(so,"gcc"),so.forEach(e),qa=o(E,"."),E.forEach(e),Ve=u(t),yt=i(t,"P",{});var ao=r(yt);Na=o(ao,"Anyway\u2026 I\u2019ve got sidetracked\u2026 back to the library!"),ao.forEach(e),Ge=u(t),vt=i(t,"H2",{});var no=r(vt);Ka=o(no,"VCS Usage"),no.forEach(e),Le=u(t),x=i(t,"P",{});var is=r(x);Wa=o(is,"The library doesn\u2019t really require any interaction: all you need to do to activate it is add the library your "),ne=i(is,"CODE",{});var oo=r(ne);Ja=o(oo,"platformio.ini"),oo.forEach(e),za=o(is," file and the rest is handled automatically."),is.forEach(e),Ue=u(t),wt=i(t,"P",{});var po=r(wt);Ya=o(po,"The library generates the following entry as a global C-struct"),po.forEach(e),Be=u(t),tt(W.$$.fragment,t),qe=u(t),J=i(t,"PRE",{class:!0});var Oo=r(J);Oo.forEach(e),Ne=u(t),_t=i(t,"P",{});var lo=r(_t);Za=o(lo,"An example output for a typical compilation may look something like this:"),lo.forEach(e),Ke=u(t),tt(z.$$.fragment,t),We=u(t),Y=i(t,"PRE",{class:!0});var xo=r(Y);xo.forEach(e),Je=u(t),$=i(t,"P",{});var rs=r($);Xa=o(rs,"You can access the "),oe=i(rs,"CODE",{});var io=r(oe);Qa=o(io,"vcs"),io.forEach(e),tn=o(rs," struct anywhere you include the header, so the output can be used in your program."),rs.forEach(e),ze=u(t),gt=i(t,"H2",{});var ro=r(gt);en=o(ro,"Checking Versions"),ro.forEach(e),Ye=u(t),Et=i(t,"P",{});var co=r(Et);sn=o(co,"Looking through binaries for an embedded bit of metadata is tedious. Ideally I would have liked to place the metadata at the start or end of the firmware binary, but doing this would involve programatically editing the linker file, which just seems like asking for trouble."),co.forEach(e),Ze=u(t),Pt=i(t,"P",{});var uo=r(Pt);an=o(uo,"Instead, the library includes a simple python script that searches for a \u2018magic pattern\u2019 that signifies the fixed-size metadata block."),uo.forEach(e),Xe=u(t),Tt=i(t,"P",{});var fo=r(Tt);nn=o(fo,"simply get your binary file, download the script and run the following python command:"),fo.forEach(e),Qe=u(t),tt(Z.$$.fragment,t),ts=u(t),X=i(t,"PRE",{class:!0});var $o=r(X);$o.forEach(e),es=u(t),A=i(t,"P",{});var cs=r(A);on=o(cs,"This will return you the metadata in "),pe=i(cs,"CODE",{});var mo=r(pe);pn=o(mo,"JSON"),mo.forEach(e),ln=o(cs," format."),cs.forEach(e),ss=u(t),S=i(t,"P",{});var us=r(S);rn=o(us,"This library was an excellent excuse to play about with the python scripting capabilities of "),le=i(us,"CODE",{});var ho=r(le);cn=o(ho,"PlatformIO"),ho.forEach(e),un=o(us,". Hopefully someone else finds it useful too!"),us.forEach(e),this.h()},h(){f(H,"href","https://github.com/BOJIT/VCS"),f(H,"rel","nofollow"),Do(lt.src,mn="https://cdn.bojit.org/img/tiles/2022-04-16-VCS.PNG")||f(lt,"src",mn),f(lt,"alt","VCS Tile"),f(P,"href","https://docs.platformio.org/en/latest/scripting/index.html"),f(P,"rel","nofollow"),f(M,"class","language-python"),f(V,"href","https://github.com/BOJIT/PlatformIO-FreeRTOS"),f(V,"rel","nofollow"),f(L,"class","language-python"),f(U,"href","https://lvgl.io/tools/imageconverter"),f(U,"rel","nofollow"),f(q,"class","language-python"),f(K,"class","language-python"),f(J,"class","language-c"),f(Y,"class","language-json"),f(X,"class","language-bash")},m(t,a){p(t,d,a),s(d,xt),s(xt,fs),s(d,ms),s(d,$t),s($t,ds),s(d,hs),s(d,At),s(At,ks),s(d,bs),s(d,H),s(H,ys),s(d,vs),p(t,ie,a),p(t,pt,a),s(pt,lt),p(t,re,a),p(t,m,a),s(m,ws),s(m,St),s(St,_s),s(m,gs),s(m,Rt),s(Rt,Es),s(m,Ps),s(m,Dt),s(Dt,Ts),s(m,Cs),s(m,jt),s(jt,Is),s(m,Os),s(m,Ht),s(Ht,xs),s(m,$s),p(t,ce,a),p(t,w,a),s(w,As),s(w,P),s(P,Ft),s(Ft,Ss),s(P,Rs),s(w,Ds),s(w,Mt),s(Mt,js),s(w,Hs),p(t,ue,a),p(t,it,a),s(it,Fs),p(t,fe,a),p(t,rt,a),s(rt,Ms),p(t,me,a),p(t,k,a),s(k,Vs),s(k,Vt),s(Vt,Gs),s(k,Ls),s(k,Gt),s(Gt,Us),s(k,Bs),s(k,Lt),s(Lt,qs),s(k,Ns),p(t,de,a),p(t,ct,a),s(ct,Ks),p(t,he,a),et(F,t,a),p(t,ke,a),p(t,M,a),M.innerHTML=bo,p(t,be,a),p(t,_,a),s(_,Ws),s(_,Ut),s(Ut,Js),s(_,zs),s(_,V),s(V,Ys),s(_,Zs),p(t,ye,a),p(t,ut,a),s(ut,Xs),p(t,ve,a),p(t,T,a),s(T,Qs),s(T,Bt),s(Bt,ta),s(T,ea),p(t,we,a),p(t,C,a),s(C,sa),s(C,qt),s(qt,aa),s(C,na),p(t,_e,a),et(G,t,a),p(t,ge,a),p(t,L,a),L.innerHTML=yo,p(t,Ee,a),p(t,I,a),s(I,oa),s(I,Nt),s(Nt,pa),s(I,la),p(t,Pe,a),p(t,ft,a),s(ft,ia),p(t,Te,a),p(t,b,a),s(b,ra),s(b,U),s(U,ca),s(b,ua),s(b,Kt),s(Kt,fa),s(b,ma),s(b,Wt),s(Wt,da),s(b,ha),p(t,Ce,a),p(t,mt,a),s(mt,ka),p(t,Ie,a),p(t,dt,a),s(dt,ba),p(t,Oe,a),p(t,ht,a),s(ht,ya),p(t,xe,a),p(t,kt,a),s(kt,va),p(t,$e,a),p(t,O,a),s(O,wa),s(O,Jt),s(Jt,_a),s(O,ga),p(t,Ae,a),et(B,t,a),p(t,Se,a),p(t,q,a),q.innerHTML=vo,p(t,Re,a),p(t,bt,a),s(bt,Ea),p(t,De,a),p(t,g,a),s(g,Pa),s(g,zt),s(zt,Ta),s(g,Ca),s(g,Yt),s(Yt,Ia),s(g,Oa),p(t,je,a),p(t,y,a),s(y,xa),s(y,Zt),s(Zt,$a),s(y,Aa),s(y,Xt),s(Xt,Sa),s(y,Ra),s(y,Qt),s(Qt,Da),s(y,ja),p(t,He,a),et(N,t,a),p(t,Fe,a),p(t,K,a),K.innerHTML=wo,p(t,Me,a),p(t,h,a),s(h,Ha),s(h,te),s(te,Fa),s(h,Ma),s(h,ee),s(ee,Va),s(h,Ga),s(h,se),s(se,La),s(h,Ua),s(h,ae),s(ae,Ba),s(h,qa),p(t,Ve,a),p(t,yt,a),s(yt,Na),p(t,Ge,a),p(t,vt,a),s(vt,Ka),p(t,Le,a),p(t,x,a),s(x,Wa),s(x,ne),s(ne,Ja),s(x,za),p(t,Ue,a),p(t,wt,a),s(wt,Ya),p(t,Be,a),et(W,t,a),p(t,qe,a),p(t,J,a),J.innerHTML=_o,p(t,Ne,a),p(t,_t,a),s(_t,Za),p(t,Ke,a),et(z,t,a),p(t,We,a),p(t,Y,a),Y.innerHTML=go,p(t,Je,a),p(t,$,a),s($,Xa),s($,oe),s(oe,Qa),s($,tn),p(t,ze,a),p(t,gt,a),s(gt,en),p(t,Ye,a),p(t,Et,a),s(Et,sn),p(t,Ze,a),p(t,Pt,a),s(Pt,an),p(t,Xe,a),p(t,Tt,a),s(Tt,nn),p(t,Qe,a),et(Z,t,a),p(t,ts,a),p(t,X,a),X.innerHTML=Eo,p(t,es,a),p(t,A,a),s(A,on),s(A,pe),s(pe,pn),s(A,ln),p(t,ss,a),p(t,S,a),s(S,rn),s(S,le),s(le,cn),s(S,un),as=!0},p:jo,i(t){as||(st(F.$$.fragment,t),st(G.$$.fragment,t),st(B.$$.fragment,t),st(N.$$.fragment,t),st(W.$$.fragment,t),st(z.$$.fragment,t),st(Z.$$.fragment,t),as=!0)},o(t){at(F.$$.fragment,t),at(G.$$.fragment,t),at(B.$$.fragment,t),at(N.$$.fragment,t),at(W.$$.fragment,t),at(z.$$.fragment,t),at(Z.$$.fragment,t),as=!1},d(t){t&&e(d),t&&e(ie),t&&e(pt),t&&e(re),t&&e(m),t&&e(ce),t&&e(w),t&&e(ue),t&&e(it),t&&e(fe),t&&e(rt),t&&e(me),t&&e(k),t&&e(de),t&&e(ct),t&&e(he),nt(F,t),t&&e(ke),t&&e(M),t&&e(be),t&&e(_),t&&e(ye),t&&e(ut),t&&e(ve),t&&e(T),t&&e(we),t&&e(C),t&&e(_e),nt(G,t),t&&e(ge),t&&e(L),t&&e(Ee),t&&e(I),t&&e(Pe),t&&e(ft),t&&e(Te),t&&e(b),t&&e(Ce),t&&e(mt),t&&e(Ie),t&&e(dt),t&&e(Oe),t&&e(ht),t&&e(xe),t&&e(kt),t&&e($e),t&&e(O),t&&e(Ae),nt(B,t),t&&e(Se),t&&e(q),t&&e(Re),t&&e(bt),t&&e(De),t&&e(g),t&&e(je),t&&e(y),t&&e(He),nt(N,t),t&&e(Fe),t&&e(K),t&&e(Me),t&&e(h),t&&e(Ve),t&&e(yt),t&&e(Ge),t&&e(vt),t&&e(Le),t&&e(x),t&&e(Ue),t&&e(wt),t&&e(Be),nt(W,t),t&&e(qe),t&&e(J),t&&e(Ne),t&&e(_t),t&&e(Ke),nt(z,t),t&&e(We),t&&e(Y),t&&e(Je),t&&e($),t&&e(ze),t&&e(gt),t&&e(Ye),t&&e(Et),t&&e(Ze),t&&e(Pt),t&&e(Xe),t&&e(Tt),t&&e(Qe),nt(Z,t),t&&e(ts),t&&e(X),t&&e(es),t&&e(A),t&&e(ss),t&&e(S)}}}const No={title:"VCS (PlatformIO Advanced Scripting)",date:"16-04-2022",published:!0,tile:{type:"image",image:"/tiles/2022-04-16-VCS.PNG"}};class Ko extends Ao{constructor(d){super(),So(this,d,null,Ho,Ro,{})}}export{Ko as default,No as metadata};
